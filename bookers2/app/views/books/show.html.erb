<main>
    <% if flash[:notice] %>
      <p class='notice'><%= flash[:notice]%></p>
    <% end %>
    <div class='container px-5 px-5m0'>
        <div class='row'>
            <div class='col-md-3'>
                <%= render 'books/info', user: @user %>
                <%= render 'books/newbook', book: @book_new %>
            </div>

            <div class='col-md-8 offset-md-1'>
                <h2>Book detail</h2>
                <table class='table table-hover table-inverse'>
                    <thead>
                        <tr>
                            <th></th>
                            <th>Title</th>
                            <th>Opinion</th>
                            <th colspan='6'></th>
                        </tr>
                    </thead>

                    <tbody>
                            <tr>
                                <td>
                                    <a href='/users/<%= @user.id %>'>
                                        <img class='attachment user profile_image fallback'><%= attachment_image_tag @user, :profile_image, :fill, 40, 40, format:'jpeg', fallback:'no_image.jpg' %><br>
                                            <%= @user.name %>
                                        </img>
                                    </a>
                                </td>
                                <td>
                                    <%= link_to @book.title, book_path(@book) %>
                                </td>

                                <td><%= @book.body %></td>
                                <% if @book.user == current_user %>
                                    <td>
                                        <%= link_to 'Edit', edit_book_path(@book), class:'btn btn-sm btn-success' %>
                                    </td>
                                    <td>
                                        <%= link_to 'Destroy', book_path(@book), class:'btn btn-sm btn-danger', method: :delete, data: {confirm: 'Are you sure?'} %>
                                    </td>
                                <% end %>

                                <td>
                                    <% if @book.favorited_by?(current_user) %>
                                        <th>
                                            <%= link_to book_otherfavorites_path(@book.id), method: :delete do %>
                                                <text class='text-danger'>♥<%= @book.favorites.count %></text>
                                            <% end %>
                                        </th>
                                    <% else %>
                                        <th>
                                            <%= link_to book_otherfavorites_path(@book.id), method: :post do %>
                                                ♡<%= @book.favorites.count %>
                                            <% end %>
                                        </th>
                                    <% end %>
                                </td>
                                <td>
                                    <th>コメント数: <%= @book.book_comments.count %></th>
                                </td>
                            </tr>
                    </tbody>
                </table>

                <div>
                    <% @book.book_comments.each do |book_comment| %>
                        <span>
                            <%= link_to user_path(book_comment.user_id) do %>
                                <%= attachment_image_tag(book_comment.user, :profile_image, :fill, 40, 40, format:'jpeg', fallback:'no_image.jpg') %>
                                <br><%= book_comment.user.name %>
                            <% end %>
                        </span>
                        <span><%= book_comment.comment %></span>
                        <span><%= link_to 'Destroy', book_book_comment_path(book_comment.book, book_comment), class:'btn btn-sm btn-danger', method: :delete, data: {confirm: 'Are you sure?'} %> </span>
                    <% end %>
                </div>
                <div>
                    <%= form_with(model:[@book, @book_comment], local: true) do |f| %>
                    <div clss='field' >
                        <%= f.text_area :comment, rows:'5', cols:'40' %>
                    </div>
                    <div class='action'>
                        <%= f.submit '送信' %>
                    </div>
                    <% end %>
                </div>

            </div>
        </div>
    </div>
</main>